// ELKS image viewer

#include <stdlib.h>
#include <stdio.h>
#include <math.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <stdint.h>
#include <ctype.h>
#include <assert.h>

extern void *malloc(size_t size);
extern void *calloc(size_t nmemb, size_t size);
extern void free(void *ptr);


#define  MAXLINE         512

int isgraph(int c)
{
  return ((c > 0x20) && (c <= 0x7E));
}

uint8_t __far *VGA = (void __far *)0xA0000000L;        /* this points to video VGA memory. */


#define VIDEO_MODE_5        0x05      /* 320x200 2-bit / CGA */
#define VIDEO_MODE_6        0x06      /* 640x200 1-bit / CGA*/
#define VIDEO_MODE_10       0x10      /* 640x350 4-bit / EGA */
#define VIDEO_MODE_12       0x12      /* 640x480 4-bit / VGA */
#define VIDEO_MODE_13       0x13      /* 320x200 8-bit / VGA */
#define TEXT_MODE_3         0x03      /* 80x25 4-bit text mode. */

/*
	AL = 00  40x25 B/W text (CGA,EGA,MCGA,VGA)
	   = 01  40x25 16 color text (CGA,EGA,MCGA,VGA)
	   = 02  80x25 16 shades of gray text (CGA,EGA,MCGA,VGA)
	   = 03  80x25 16 color text (CGA,EGA,MCGA,VGA)
	   = 04  320x200 4 color graphics (CGA,EGA,MCGA,VGA)
	   = 05  320x200 4 color graphics (CGA,EGA,MCGA,VGA)
	   = 06  640x200 B/W graphics (CGA,EGA,MCGA,VGA)
	   = 07  80x25 Monochrome text (MDA,HERC,EGA,VGA)
	   = 08  160x200 16 color graphics (PCjr)
	   = 09  320x200 16 color graphics (PCjr)
	   = 0A  640x200 4 color graphics (PCjr)
	   = 0B  Reserved (EGA BIOS function 11)
	   = 0C  Reserved (EGA BIOS function 11)
	   = 0D  320x200 16 color graphics (EGA,VGA)
	   = 0E  640x200 16 color graphics (EGA,VGA)
	   = 0F  640x350 Monochrome graphics (EGA,VGA)
	   = 10  640x350 16 color graphics (EGA or VGA with 128K)
		 640x350 4 color graphics (64K EGA)
	   = 11  640x480 B/W graphics (MCGA,VGA)
	   = 12  640x480 16 color graphics (VGA)
	   = 13  320x200 256 color graphics (MCGA,VGA)
*/

uint8_t vgapal[256][3] = {
    /* colors 0-15 */
    {0x00, 0x00, 0x00},

    {0x00, 0x00, 0xAA},
    {0x00, 0xAA, 0x00},
    {0x00, 0xAA, 0xAA},
    {0xAA, 0x00, 0x00},
    {0xAA, 0x00, 0xAA},

    {0xAA, 0x55, 0x00},
    {0xAA, 0xAA, 0xAA},
    {0x55, 0x55, 0x55},
    {0x55, 0x55, 0xFF},
    {0x55, 0xFF, 0x55},

    {0x55, 0xFF, 0xFF},
    {0xFF, 0x55, 0x55},
    {0xFF, 0x55, 0xFF},
    {0xFF, 0xFF, 0x55},
    {0xFF, 0xFF, 0xFF},

    /* grayscale 16-31 (non gamma corrected */
    {0x00, 0x00, 0x00},
    {0x14, 0x14, 0x14},
    {0x20, 0x20, 0x20},
    {0x2C, 0x2C, 0x2C},
    {0x38, 0x38, 0x38},

    {0x45, 0x45, 0x45},
    {0x51, 0x51, 0x51},
    {0x61, 0x61, 0x61},
    {0x71, 0x71, 0x71},
    {0x82, 0x82, 0x82},

    {0x92, 0x92, 0x92},
    {0xA2, 0xA2, 0xA2},
    {0xB6, 0xB6, 0xB6},
    {0xCB, 0xCB, 0xCB},
    {0xE3, 0xE3, 0xE3},

    {0xFF, 0xFF, 0xFF},
    // HERE ------> 1
    /* hue mix 32-55 (1 */
    {0x00, 0x00, 0xFF},
    {0x41, 0x00, 0xFF},
    {0x7D, 0x00, 0xFF},
    {0xBE, 0x00, 0xFF},

    {0xFF, 0x00, 0xFF},
    {0xFF, 0x00, 0xBE},
    {0xFF, 0x00, 0x7D},
    {0xFF, 0x00, 0x41},
    {0xFF, 0x00, 0x00},

    {0xFF, 0x41, 0x00},
    {0xFF, 0x7D, 0x00},
    {0xFF, 0xBE, 0x00},
    {0xFF, 0xFF, 0x00},
    {0xBE, 0xFF, 0x00},

    {0x7D, 0xFF, 0x00},
    {0x41, 0xFF, 0x00},
    {0x00, 0xFF, 0x00},
    {0x00, 0xFF, 0x41},
    {0x00, 0xFF, 0x7D},

    {0x00, 0xFF, 0xBE},
    {0x00, 0xFF, 0xFF},
    {0x00, 0xBE, 0xFF},
    {0x00, 0x7D, 0xFF},
    {0x00, 0x41, 0xFF},

    /* hue mix 56-79 (2 */
    {0x7D, 0x7D, 0xFF},
    {0x9E, 0x7D, 0xFF},
    {0xBE, 0x7D, 0xFF},
    {0xDF, 0x7D, 0xFF},
    {0xFF, 0x7D, 0xFF},

    {0xFF, 0x7D, 0xDF},
    {0xFF, 0x7D, 0xBE},
    {0xFF, 0x7D, 0x9E},
    {0xFF, 0x7D, 0x7D},
    {0xFF, 0x9E, 0x7D},

    {0xFF, 0xBE, 0x7D},
    {0xFF, 0xDF, 0x7D},
    {0xFF, 0xFF, 0x7D},
    {0xDF, 0xFF, 0x7D},
    {0xBE, 0xFF, 0x7D},

    {0x9E, 0xFF, 0x7D},
    {0x7D, 0xFF, 0x7D},
    {0x7D, 0xFF, 0x9E},
    {0x7D, 0xFF, 0xBE},
    {0x7D, 0xFF, 0xDF},

    {0x7D, 0xFF, 0xFF},
    {0x7D, 0xDF, 0xFF},
    {0x7D, 0xBE, 0xFF},
    {0x7D, 0x9E, 0xFF},
    /* hue mix 80-103 (3 */
    {0xB6, 0xB6, 0xFF},

    {0xC7, 0xB6, 0xFF},
    {0xDB, 0xB6, 0xFF},
    {0xEB, 0xB6, 0xFF},
    {0xFF, 0xB6, 0xFF},
    {0xFF, 0xB6, 0xEB},

    {0xFF, 0xB6, 0xDB},
    {0xFF, 0xB6, 0xC7},
    {0xFF, 0xB6, 0xB6},
    {0xFF, 0xC7, 0xB6},
    {0xFF, 0xDB, 0xB6},

    {0xFF, 0xEB, 0xB6},
    {0xFF, 0xFF, 0xB6},
    {0xEB, 0xFF, 0xB6},
    {0xDB, 0xFF, 0xB6},
    {0xC7, 0xFF, 0xB6},

    {0xB6, 0xFF, 0xB6},
    {0xB6, 0xFF, 0xC7},
    {0xB6, 0xFF, 0xDB},
    {0xB6, 0xFF, 0xEB},
    {0xB6, 0xFF, 0xFF},

    {0xB6, 0xEB, 0xFF},
    {0xB6, 0xDB, 0xFF},
    {0xB6, 0xC7, 0xFF},
    // HERE ------> 2
    /* hue mix 104-127 (4 dark 1 */
    {0x00, 0x00, 0x71},
    {0x1C, 0x00, 0x71},
    {0x38, 0x00, 0x71},
    {0x55, 0x00, 0x71},

    {0x71, 0x00, 0x71},
    {0x71, 0x00, 0x55},
    {0x71, 0x00, 0x38},
    {0x71, 0x00, 0x1C},
    {0x71, 0x00, 0x00},

    {0x71, 0x1C, 0x00},
    {0x71, 0x38, 0x00},
    {0x71, 0x55, 0x00},
    {0x71, 0x71, 0x00},
    {0x55, 0x71, 0x00},

    {0x38, 0x71, 0x00},
    {0x1C, 0x71, 0x00},
    {0x00, 0x71, 0x00},
    {0x00, 0x71, 0x1C},
    {0x00, 0x71, 0x38},

    {0x00, 0x71, 0x55},
    {0x00, 0x71, 0x71},
    {0x00, 0x55, 0x71},
    {0x00, 0x38, 0x71},
    {0x00, 0x1C, 0x71},

    /* hue mix 56-79 (2 */
    {0x38, 0x38, 0x71},
    {0x45, 0x38, 0x71},
    {0x55, 0x38, 0x71},
    {0x61, 0x38, 0x71},
    {0x71, 0x38, 0x71},

    {0x71, 0x38, 0x61},
    {0x71, 0x38, 0x55},
    {0x71, 0x38, 0x45},
    {0x71, 0x38, 0x38},
    {0x71, 0x45, 0x38},

    {0x71, 0x55, 0x38},
    {0x71, 0x61, 0x38},
    {0x71, 0x71, 0x38},
    {0x61, 0x71, 0x38},
    {0x55, 0x71, 0x38},

    {0x45, 0x71, 0x38},
    {0x38, 0x71, 0x38},
    {0x38, 0x71, 0x45},
    {0x38, 0x71, 0x55},
    {0x38, 0x71, 0x61},

    {0x38, 0x71, 0x71},
    {0x38, 0x61, 0x71},
    {0x38, 0x55, 0x71},
    {0x38, 0x45, 0x71},
    /* hue mix 80-103 (3 */
    {0x51, 0x51, 0x71},

    {0x59, 0x51, 0x71},
    {0x61, 0x51, 0x71},
    {0x69, 0x51, 0x71},
    {0x71, 0x51, 0x71},
    {0x71, 0x51, 0x69},

    {0x71, 0x51, 0x61},
    {0x71, 0x51, 0x59},
    {0x71, 0x51, 0x51},
    {0x71, 0x59, 0x51},
    {0x71, 0x61, 0x51},

    {0x71, 0x69, 0x51},
    {0x71, 0x71, 0x51},
    {0x69, 0x71, 0x51},
    {0x61, 0x71, 0x51},
    {0x59, 0x71, 0x51},

    {0x51, 0x71, 0x51},
    {0x51, 0x71, 0x59},
    {0x51, 0x71, 0x61},
    {0x51, 0x71, 0x69},
    {0x51, 0x71, 0x71},

    {0x51, 0x69, 0x71},
    {0x51, 0x61, 0x71},
    {0x51, 0x59, 0x71},
    // HERE ------> 3
    /* hue mix 104-127 (4 dark 1 */
    {0x00, 0x00, 0x41},
    {0x10, 0x00, 0x41},
    {0x20, 0x00, 0x41},
    {0x30, 0x00, 0x41},

    {0x41, 0x00, 0x41},
    {0x41, 0x00, 0x30},
    {0x41, 0x00, 0x20},
    {0x41, 0x00, 0x10},
    {0x41, 0x00, 0x00},

    {0x41, 0x10, 0x00},
    {0x41, 0x20, 0x00},
    {0x41, 0x30, 0x00},
    {0x41, 0x41, 0x00},
    {0x30, 0x41, 0x00},

    {0x20, 0x41, 0x00},
    {0x10, 0x41, 0x00},
    {0x00, 0x41, 0x00},
    {0x00, 0x41, 0x10},
    {0x00, 0x41, 0x20},

    {0x00, 0x41, 0x30},
    {0x00, 0x41, 0x41},
    {0x00, 0x30, 0x41},
    {0x00, 0x20, 0x41},
    {0x00, 0x10, 0x41},

    /* hue mix 56-79 (2 */
    {0x20, 0x20, 0x41},
    {0x28, 0x20, 0x41},
    {0x30, 0x20, 0x41},
    {0x3C, 0x20, 0x41},
    {0x41, 0x20, 0x41},

    {0x41, 0x20, 0x3C},
    {0x41, 0x20, 0x30},
    {0x41, 0x20, 0x28},
    {0x41, 0x20, 0x20},
    {0x41, 0x28, 0x20},

    {0x41, 0x30, 0x20},
    {0x41, 0x3C, 0x20},
    {0x41, 0x41, 0x20},
    {0x3C, 0x41, 0x20},
    {0x30, 0x41, 0x20},

    {0x28, 0x41, 0x20},
    {0x20, 0x41, 0x20},
    {0x20, 0x41, 0x28},
    {0x20, 0x41, 0x30},
    {0x20, 0x41, 0x3C},

    {0x20, 0x41, 0x41},
    {0x20, 0x3C, 0x41},
    {0x20, 0x30, 0x41},
    {0x20, 0x28, 0x41},
    /* hue mix 80-103 (3 */
    {0x2C, 0x2C, 0x41},

    {0x30, 0x2C, 0x41},
    {0x34, 0x2C, 0x41},
    {0x3C, 0x2C, 0x41},
    {0x41, 0x2C, 0x41},
    {0x41, 0x2C, 0x3C},

    {0x41, 0x2C, 0x34},
    {0x41, 0x2C, 0x30},
    {0x41, 0x2C, 0x2C},
    {0x41, 0x30, 0x2C},
    {0x41, 0x34, 0x2C},

    {0x41, 0x3C, 0x2C},
    {0x41, 0x41, 0x2C},
    {0x3C, 0x41, 0x2C},
    {0x34, 0x41, 0x2C},
    {0x30, 0x41, 0x2C},

    {0x2C, 0x41, 0x2C},
    {0x2C, 0x41, 0x30},
    {0x2C, 0x41, 0x34},
    {0x2C, 0x41, 0x3C},
    {0x2C, 0x41, 0x41},

    {0x2C, 0x3C, 0x41},
    {0x2C, 0x34, 0x41},
    {0x2C, 0x30, 0x41},

    /* all black */
    {0, 0, 0},
    {0, 0, 0},
    {0, 0, 0},
    {0, 0, 0},

    {0, 0, 0},
    {0, 0, 0},
    {0, 0, 0},
    {0, 0, 0},

};

uint8_t rgb2vga(int r, int g, int b) {

	int closest = 32000;
	int ndx = 0;
	for (int i = 0; i < 248; i++) {
		uint8_t *sample = vgapal[i];
		int rs = (sample[0] > r)? sample[0] - r : r - sample[0];
		int gs = (sample[1] > g)? sample[1] - g : g - sample[1];
		int bs = (sample[2] > b)? sample[2] - b : b - sample[2];
		int dst = rs + gs + bs;

		// printf("dist %d\n", dst);

		if (closest > dst) {
			closest = dst;
			ndx = i;
		}
		else if (dst < 30) {
			ndx = i;
			break;
		}

	}

	return (uint8_t)ndx;
}

void plot_pixel(int x,int y, uint8_t color)
{
	// x + (y*320)
     /*  y*320 = y*256 + y*64 = y*2^8 + y*2^6   */
    int offset = (y<<8)+(y<<6)+x;
	VGA[offset] = color;
}

void mode13();
#pragma aux mode13 =								\
"mov AH,0", \
"mov AL,13H", \
"int 10H", \
modify [ AH AL ];

void mode12();
#pragma aux mode12 =								\
"mov AH,0", \
"mov AL,12H", \
"int 10H", \
modify [ AH AL ];

void mode10();
#pragma aux mode10 =								\
"mov AH,0", \
"mov AL,10H", \
"int 10H", \
modify [ AH AL ];

void mode6();
#pragma aux mode6 =								\
"mov AH,0", \
"mov AL,6H", \
"int 10H", \
modify [ AH AL ];

void mode5();
#pragma aux mode5 =								\
"mov AH,0", \
"mov AL,5H", \
"int 10H", \
modify [ AH AL ];

void mode3();
#pragma aux mode3 =								\
"mov AH,0", \
"mov AL,3H", \
"int 10H", \
modify [ AH AL ];

#if 0 // TODO: implement other functions...
void get_mode();
#pragma aux mode10 parm [ax bx cx dx] value [ax] =								\
"mov AH,0", \
"mov AL,10H", \
"int 10H", \
modify [ AH AL ];
#endif

void set_mode(uint8_t mode)
{
	if (mode == VIDEO_MODE_13)
		mode13();
	if (mode == VIDEO_MODE_12)
		mode12();
	if (mode == VIDEO_MODE_10)
		mode10();
	if (mode == VIDEO_MODE_5)
		mode5();
	if (mode == VIDEO_MODE_6)
		mode6();
	if (mode == TEXT_MODE_3)
		mode3();
}

static int print_usage()
{
   printf("Usage: ppmview [source_file.ppm]\n");
   printf("source_file: PPM file to decode.\n");
   printf("\n");
   printf("Displays a ppm image in the screen.\n");
   printf("\n");
   return EXIT_FAILURE;
}

int ppm_load_and_display(const char *pFilename)
{
	int x_val, y_val, maxcolors_val;
	unsigned int i;
	char magic[MAXLINE];
	char line[MAXLINE];
	int count=0;
	int is_ascii = 0;

	FILE *f = fopen(pFilename, "rb");
	if (!f)
    {
        fprintf(stderr,"Error opening the file\n");
		return -1;
    }

	/* Read the PPM file header. */
	while (fgets(line, MAXLINE, f) != NULL) {
		int flag = 0;
		for (i = 0; i < strlen(line); i++) {
			if (isgraph(line[i]) && (flag == 0)) {
				if ((line[i] == '#') && (flag == 0)) {
					flag = 1;
				}
			}
		}
		if (flag == 0) {
			if (count == 0) {
				count += sscanf(line, "%2s %d %d %d", magic, &x_val, &y_val, &maxcolors_val);
			} else if (count == 1) {
				count += sscanf(line, "%d %d %d", &x_val, &y_val, &maxcolors_val);
			} else if (count == 2) {
				count += sscanf(line, "%d %d", &y_val, &maxcolors_val);
			} else if (count == 3) {
				count += sscanf(line, "%d", &maxcolors_val);
			}
		}
		if (count == 4) {
			break;
		}
	}

	if (strcmp(magic, "P3") == 0) {
		is_ascii = 1;
	} else if (strcmp(magic, "P6") == 0) {
		is_ascii = 0;
	} else {
		fprintf(stderr, "Error: Input file not in PPM format!\n");
		return -1;
	}
	 int c;
	int r_val, g_val, b_val;

	/* Read the rest of the PPM file. */
	i = 0;
	int j = 0, k = 0;
	while ((c = fgetc(f)) != EOF) {
		ungetc(c, f);
		if (is_ascii == 1) {
			if (fscanf(f, "%d %d %d", &r_val, &g_val, &b_val) != 3)
				return -1;
		} else {
			r_val = fgetc(f);
			g_val = fgetc(f);
			b_val = fgetc(f);
		}

		uint8_t pixel = rgb2vga(r_val, g_val, b_val);
		plot_pixel(k, j, pixel);
		k++;
		if (k == x_val)
		{
			k = 0;
			j++;
		}
	}
    return 0;
}

//------------------------------------------------------------------------------
int main(int arg_c, char *arg_v[])
{
   int n = 1;
   const char *filename;

   printf("ELKS PPM Viewer v0.1\n");

   if (arg_c != 2)
      return print_usage();
   
   filename = arg_v[n];

   printf("Source file:      \"%s\"\n", filename);

   sleep(1);
   set_mode(VIDEO_MODE_13);

   int ret = ppm_load_and_display(filename);
   sleep(10);
   set_mode(TEXT_MODE_3);

   return ret;

   return EXIT_SUCCESS;
}
//------------------------------------------------------------------------------

